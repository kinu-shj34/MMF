# アルゴリズム概要（書き換え版）

このドキュメントは、`OptimizationEngine` と `SimulationEngine` の内容をもとに、  
アプリケーション全体の「考え方」と「計算の流れ」を説明したものです。  
細かな実装よりも **「何を、どの順番で、なぜ計算するのか」** を中心にまとめています。

---

## 1. まず何をしたいアプリなのか

このアプリがしたいことは、**広告予算をどこに使えば、ターゲットの認知が一番伸びるか** を数値で判断できるようにすることです。  
加えて、**その効果が時間とともにどう変わるか** も追えるようにしています。

### 入力（主に使うデータ）
- ターゲット人口（性別・年齢など）
- メディアごとの特性（オンターゲット率、媒体利用率、CPM）
- 予算（総額または月別）

### 出力（得たい答え）
- 最終的な認知率（%）
- メディア別の最適配分（最適化モード）
- 月ごとの認知推移（シミュレーションモード）

### 2つのモード
- **最適化モード（Optimization）**:  
  総予算を「どのメディアにどれくらい配分すれば認知が最大か」を探す。
- **シミュレーションモード（Simulation）**:  
  月ごとの予算を固定し、認知が時間とともにどう増減するかを追う。

---

## 2. 全体の流れ（共通部分）

どちらのモードでも計算の骨格は同じです。  
**「ターゲット → 接触 → 認知」** の順に積み上げます。

```
1. ターゲット定義（性別 × 年齢層など）
2. ターゲット人口を確定
3. メディア親和性を計算（その層に届きやすい度合い）
4. 接触可能人口を計算
5. 予算をインプレッションに変換
6. 接触頻度分布（何回当たるか）を推定
7. 接触回数から認知率を計算
8. メディア間の重複を調整して統合
```

以降で、主要な計算を「説明 → 数式 → 記号の説明」の順で示します。

---

## 3. 基本処理（共通）

### 3.1 メディア親和性の計算
前提として、広告は「誰にでも同じ確率で届く」わけではありません。  
媒体によって **どの層に届きやすいか** に偏りがあるため、その偏りを数値化します。  
そこで「そのメディアがターゲットにどのくらい届きやすいか」を表す **親和性率** を作ります。  
これは「オンターゲット率」と「媒体利用率」の掛け算です。

ここでいう **セグメント** は、性別・年齢層などで切った「ターゲットの区分」を指します。  
たとえば「女性×20代」のように分け、その区分ごとに届きやすさを計算します。

```mermaid
flowchart TB
  A[ターゲット定義<br/>セグメント = 性別×年齢層] --> B[メディア特性]
  B --> C1[オンターゲット率<br/>Accuracy_m]
  B --> C2[媒体利用率<br/>Usage_{m,s}]
  C1 --> D[親和性率<br/>Affinity_{m,s} = Accuracy_m × Usage_{m,s}]
  C2 --> D
  D --> E[意味: そのメディアが<br/>そのセグメントに届きやすい度合い]
```

$$
Affinity_{m,s} = Accuracy_m \times Usage_{m,s}
$$

- $Affinity_{m,s}$: メディア $m$ がセグメント $s$ に届く親和性率  
- $Accuracy_m$: メディア $m$ のオンターゲット率（「この媒体の利用者のうち、どれだけが狙いの層か」）  
- $Usage_{m,s}$: メディア $m$ をセグメント $s$ が利用する割合（「その層のうち、どれだけがこの媒体を使うか」）  

つまり **「媒体の利用者は誰か」** と **「その層は媒体を使うか」** の両面から、  
ターゲットに当たりやすい度合いを1つの数字にまとめています。

---

### 3.2 接触可能人口の計算

親和性率がわかっても、そこから「実際に何人に届く可能性があるか」はまだ見えません。  
そこで、ターゲットの母数に親和性率を掛けて、**広告が届き得る人数** を見積もります。  
これが **接触可能人口** で、以降の「表示回数」や「認知率」を計算する土台になります。

$$
Contact_{m,s} = Population_s \times Affinity_{m,s}
$$

- $Contact_{m,s}$: メディア $m$ でセグメント $s$ に届く人数
- $Population_s$: セグメント $s$ の人口（ターゲットの母数）  
- $Affinity_{m,s}$: 親和性率  

例えば、ターゲット人口が100万人で親和性率が0.2なら、  
その媒体で **最大20万人に届く可能性がある** と解釈します。 

---

### 3.3 予算からインプレッションを計算

まず、予算というお金の単位を「どれだけ表示されたか」という回数の単位に置き換えます。  
広告効果は表示回数を起点に積み上がるため、ここで **予算 → インプレッション** に変換します。  
CPMは「1000回表示あたりの費用」で、単価として使います。

$$
Impressions_m = \frac{Budget_m}{CPM_m} \times 1000
$$

- $Impressions_m$: メディア $m$ のインプレッション数（広告が表示された回数）  
- $Budget_m$: メディア $m$ に使う予算（円など）  
- $CPM_m$: メディア $m$ のCPM（1000回表示あたりの費用）  

つまり **「1000回表示にいくらかかるか」** を使って、  
予算を表示回数に換算しています。

---

### 3.4 接触頻度の分布（NBD）

広告は「同じ人に何回も当たる」ことがあります。  
そのため、平均回数だけでなく **「0回の人がどれくらいいるか」「何回も当たる人がどれくらいいるか」** を見積もる必要があります。  
そこで **負の二項分布（NBD: Negative Binomial Distribution）** を使い、
「0回、1回、2回…接触する確率」を推定します。

負の二項分布は、**平均だけでは説明できない“ばらつき”がある回数データ** に向いています。  
広告接触は、人によって当たりやすさが違い、ゼロ回の人も多く出るため、  
**「平均回数＋ばらつき」を同時に表現できる分布** が必要になります。  
NBDは、**平均回数 $\mu$ とばらつきの大きさ（形状パラメータ $\alpha$）** で形が決まり、  
「ほとんど当たらない人が多い」ケースから「広く当たる」ケースまで表現できます。

$$
P(X = k) = \binom{k+r-1}{k} p^r (1-p)^k
$$

- $P(X = k)$: $k$ 回接触する確率  
- $r$: 形状パラメータ（α、ばらつきの大きさを決める）  
- $p$: 成功確率（「当たりやすさ」に相当する確率）   
- $k$: 接触回数（0,1,2,…）

平均接触頻度 $\mu$ との関係は次の通りです。

$$
p = \frac{\alpha}{\alpha + \mu}
$$

- $\mu$: 平均接触頻度  
- $\alpha$: 形状パラメータ（ばらつきの強さ）  
- $p$: 成功確率  

この式は、**平均回数 $\mu$ が分かれば、分布の形（$p$）が決まる** ことを示しています。  
つまり、平均とばらつきの2つで「0回の人がどれくらいか」まで推定できます。

---

##ひとまずこの前まで文章、数式の説明の修正を実施

### 3.5 認知率の計算（接触回数 → 認知）

「何回接触したら認知するか」を確率で表します。  
初期認知率 $\gamma$ を持っている人もいるため、その分を含めて計算します。

$$
P(認知 \mid f) = 1 - (1 - \gamma)\,(1 - \theta)^f
$$

- $P(認知 \mid f)$: $f$ 回接触したときの認知確率  
- $\gamma$: 初期認知率  
- $\theta$: 1回接触あたりの認知獲得確率  
- $f$: 接触回数

---

### 3.6 メディア間の重複調整

複数メディアを使うと「同じ人に重複して届く」ため、  
単純に足すと過大評価になります。そこで **重複係数 $k$** を使います。

$$
R_{combined} = R_a + R_b - k \, R_a R_b
$$

- $R_{combined}$: 2メディア統合後の認知率  
- $R_a, R_b$: 各メディアの認知率  
- $k$: 重複係数

$k$ の意味は次の通りです。

- 独立の場合: $k = 1$
- 重複が大きい場合: $k > 1$

3媒体以上の場合は、**「すでに統合済みのメディア群」と「新しく追加するメディア」** を順に統合します。  
このときの重複係数 $k$ は、既存メディアとのペア係数を認知率で加重平均して求めます。

$$
k_{eff} = \frac{\sum_i w_i k_i}{\sum_i w_i}
$$

- $k_{eff}$: 新メディアを統合する際の有効重複係数  
- $k_i$: 既存メディア $i$ と新メディアの重複係数  
- $w_i$: 既存メディア $i$ の認知率（重み）  

※ もし $\sum_i w_i = 0$（既存メディアの認知率がすべて0）の場合は、単純平均で代用します。

---

### 3.7 忘却効果（時間が経つと認知が薄れる）

シミュレーションでは、認知が時間とともに薄れる効果を入れます。  
月次の忘却率 $\delta$ から日次の忘却率を計算し、日数分だけ減衰させます。

$$
R(t) = R(0)\,(1 - r)^t
$$

- $R(t)$: $t$ 日後の認知率  
- $R(0)$: 現在の認知率  
- $r$: 日次の忘却率  
- $t$: 経過日数

日次の忘却率は次で求めます。

$$
r = 1 - (1 - \delta)^{1/30}
$$

- $\delta$: 30日間の忘却率  
- $r$: 1日あたりの忘却率

---

### 3.8 統合フリークエンシーの算出

複数メディアの「接触回数の分布（フリークエンシー分布）」を1つにまとめる手順です。  
基本は **独立と仮定した畳み込み** を行い、その後 **1回以上接触（R(1))** を重複係数で調整します。

まず、2メディアの頻度分布を独立として畳み込みます。

$$
P_{total}(k) = \sum_{i=0}^{k} P_a(i) P_b(k-i)
$$

- $P_{total}(k)$: 統合後に $k$ 回接触する確率  
- $P_a(i)$: メディアAで $i$ 回接触する確率  
- $P_b(k-i)$: メディアBで $k-i$ 回接触する確率  

次に、**1回以上接触率**を計算します。

$$
R_1 = 1 - P(0)
$$

- $R_1$: 1回以上接触する確率  
- $P(0)$: 0回接触する確率  

重複係数 $k$ を使って、R(1) の統合値（目標値）を求めます。

$$
R_{1,target} = R_{1,a} + R_{1,b} - k \, R_{1,a} R_{1,b}
$$

- $R_{1,target}$: 重複調整後の1回以上接触率  
- $R_{1,a}, R_{1,b}$: 各メディアの1回以上接触率  
- $k$: 重複係数  

最後に、畳み込みで得た分布の **$k \ge 1$ の部分を一律でスケール** して、  
R(1)が $R_{1,target}$ になるよう合わせます。

$$
P'_{total}(k) =
\begin{cases}
1 - R_{1,target} & (k = 0) \\
P_{total}(k) \times \frac{R_{1,target}}{R_{1,conv}} & (k \ge 1)
\end{cases}
$$

- $P'_{total}(k)$: 調整後の統合頻度分布  
- $R_{1,conv}$: 畳み込み結果の $R(1)$（$1 - P_{total}(0)$）  

3媒体以上の場合は、この統合を順番に繰り返します（R(1)の重複調整は 3.6 と同じ考え方）。

---

## 4. モード別の違い

### 4.1 最適化モード（Optimization）

このモードでは、総予算を **どのメディアに配分すれば認知が最大になるか** を探します。  
実際には「認知率を最大化」＝「負の値を最小化」という形で最適化を行います。

$$
\min\; f(x) = -Recognition(x) \times 10000
$$

- $x$: メディア別予算比率  
- $Recognition(x)$: その配分での最終認知率  
- $10000$: 計算の安定性を上げるためのスケーリング

制約は「予算比率の合計が1」「各メディアに上限・下限がある」などです。

---

### 4.2 シミュレーションモード（Simulation）

このモードでは **月ごとの予算は固定** で、  
「忘却 → 広告効果 → 認知の更新」を毎月繰り返します。

$$
Awareness_{month} = 1 - (1 - Current)\,(1 - New)
$$

- $Awareness_{month}$: 月末の認知率  
- $Current$: 忘却後の月初認知率  
- $New$: その月の広告による新規認知率

---

## 5. まとめ（非技術者向けの一言）

このアプリは、  
**「誰に」「どのメディアで」「何回当たり」「どれだけ認知されるか」**  
を、統計モデル（NBD）と重複調整を使って現実的に見積もる仕組みです。

- 最適化モード：一番効率の良い配分を探す  
- シミュレーションモード：時間とともに認知がどう動くかを見る

必要なのは、**人口データ・予算・媒体特性**。  
それらを使って「広告効果の全体像」をわかりやすく数値化します。
